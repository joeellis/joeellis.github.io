<!DOCTYPE html> <html> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width initial-scale=1"> <title>Nested Modules and Auto-Aliasing in Elixir | joeellis.la</title> <meta property="og:title" content="Nested Modules and Auto-Aliasing in Elixir"/> <meta name="author" content="Joe Ellis"/> <meta property="og:locale" content="en_US"/> <meta name="description" content="How Elixir handles compiling nested modules in the background."/> <meta property="og:description" content="How Elixir handles compiling nested modules in the background."/> <link rel="canonical" href="http://localhost:4000/elixir-nested-modules/"/> <meta property="og:url" content="http://localhost:4000/elixir-nested-modules/"/> <meta property="og:site_name" content="joeellis.la"/> <meta property="og:type" content="article"/> <meta property="article:published_time" content="2017-05-10T00:00:00-05:00"/> <meta name="twitter:card" content="summary"/> <meta name="twitter:site" content="@notjoellis"/> <meta name="twitter:creator" content="@Joe Ellis"/> <script type="application/ld+json">
{"@context":"http://schema.org","@type":"BlogPosting","headline":"Nested Modules and Auto-Aliasing in Elixir","author":{"@type":"Person","name":"Joe Ellis"},"datePublished":"2017-05-10T00:00:00-05:00","dateModified":"2017-05-10T00:00:00-05:00","description":"How Elixir handles compiling nested modules in the background.","publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/avatar.png"},"name":"Joe Ellis"},"mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/elixir-nested-modules/"},"url":"http://localhost:4000/elixir-nested-modules/"}</script> <link rel="stylesheet" href="/css/main.css"> <link rel="alternate" type="application/atom+xml" title="joeellis.la" href="http://localhost:4000/feed.xml"/> <link rel="canonical" href="http://localhost:4000/elixir-nested-modules/"> <link href="https://fonts.googleapis.com/css?family=Droid+Serif|Oxygen" rel="stylesheet"> <meta content="How Elixir handles compiling nested modules in the background." property="description"> <meta property="og:image" content="http://localhost:4000/assets/images/avatar.png"> <meta property="article:tag" content="elixir"> <meta name="twitter:title" content="Nested Modules and Auto-Aliasing in Elixir"> <meta name="twitter:description" content="How Elixir handles compiling nested modules in the background."> <meta name="twitter:image" content="http://localhost:4000/assets/images/avatar.png"> </head> <body> <div class="site-container"> <div class="wrapper"> <a class="rss-link" href="/feed.xml"> <i class="fa fa-rss" aria-hidden="true"></i> </a> <div class="page-content"> <div class="header-intro"> <div class="intro-details"> <div class="intro-photo"> <a href="http://localhost:4000"> <img class="avatar-photo" src="/assets/images/avatar.png" width="55" height="55"/> </a> </div> <p class="intro-description"> My name is Joe Ellis and I am a full stack developer in New Orleans, interested all things Elixir, Ruby, and Javascript. </p> </div> </div> <hr/> <div class="post"> <header class="post-header"> <h1 class="post-title">Nested Modules and Auto-Aliasing in Elixir</h1> <p class="post-meta">May 10, 2017</p> </header> <article class="post-content"> <p>Recently, I was coding a module to create CSV files from database records when I came across an unexpected error in Elixir. Using the <a href="https://github.com/beatrichartz/csv">CSV</a> library, I wrote something like this:</p> <figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="c1"># mix.exs</span>
<span class="k">defp</span> <span class="n">deps</span> <span class="k">do</span>
  <span class="p">[</span>
    <span class="p">{</span><span class="ss">:csv</span><span class="p">,</span> <span class="sd">"</span><span class="s2">~&gt; 1.4.2"</span><span class="p">}</span>
    <span class="o">...</span>
  <span class="p">]</span>
<span class="k">end</span>

<span class="c1"># csv.ex</span>
<span class="k">defmodule</span> <span class="no">Foo</span> <span class="k">do</span>
  <span class="k">defmodule</span> <span class="no">CSV</span> <span class="k">do</span>
    <span class="k">def</span> <span class="n">export</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">CSV</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>I expected <code class="highlighter-rouge">Foo.CSV.export(file)</code> to trigger the <code class="highlighter-rouge">CSV</code> library to encode the file I passed into the function. To my surprise, the app came back with this error:</p> <figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="p">(</span><span class="no">UndefinedFunctionError</span><span class="p">)</span> <span class="n">function</span> <span class="no">Foo</span><span class="o">.</span><span class="no">CSV</span><span class="o">.</span><span class="n">encode</span><span class="o">/</span><span class="m">1</span> <span class="n">is</span> <span class="n">undefined</span>
<span class="ow">or</span> <span class="n">private</span></code></pre></figure> <p>This error kind of makes sense. I’m calling a function on a <code class="highlighter-rouge">CSV</code> module, and I <em>just</em> defined a named <code class="highlighter-rouge">CSV</code> module right above it. Naturally, the app should be confused as to which <code class="highlighter-rouge">CSV</code> module I’m referring to. But I really didn’t want to change my module’s name, so how can I tell the app which module I want to use?</p> <p>After some experimenting, I found something even more interesting - switching from a nested module to a single namespaced module made it work:</p> <figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="c1"># csv.ex</span>
<span class="k">defmodule</span> <span class="no">Foo</span><span class="o">.</span><span class="no">CSV</span> <span class="k">do</span>
  <span class="k">def</span> <span class="n">export</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span>
    <span class="no">CSV</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>What?? I thought nested modules and namespaced modules compiled to the same thing? Shouldn’t the first example also compile to <code class="highlighter-rouge">Foo.CSV</code>? And why does the second example not throw the same error as the first one?</p> <h3 id="why-this-happens">Why this happens</h3> <p>After asking around, I found this behavior puzzled other Elixir developers as well. Thankfully, <a href="http://github.com/bryanjos">Bryan Joseph</a> helped me figure out what was happening and also pointed me to part in <a href="https://hexdocs.pm/elixir/Kernel.html#defmodule/2-nesting">the docs</a> that explains this behavior.</p> <p>While compiling, when Elixir reaches a nested module, it creates an “auto-alias” for that nested module. In other words, this code:</p> <figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Foo</span> <span class="k">do</span>
  <span class="k">defmodule</span> <span class="no">CSV</span> <span class="k">do</span>
    <span class="k">def</span> <span class="n">export</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">CSV</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure> <p>actually compiles to something more like this behind the scenes:</p> <figure class="highlight"><pre><code class="language-elixir" data-lang="elixir"><span class="k">defmodule</span> <span class="no">Foo</span> <span class="k">do</span>
  <span class="k">defmodule</span> <span class="no">Foo</span><span class="o">.</span><span class="no">CSV</span> <span class="k">do</span>
    <span class="k">def</span> <span class="n">export</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">do</span>
      <span class="no">CSV</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">alias</span> <span class="no">Foo</span><span class="o">.</span><span class="no">CSV</span><span class="p">,</span> <span class="ss">as:</span> <span class="no">CSV</span>
<span class="k">end</span></code></pre></figure> <p>This is why my original example threw an error - when <code class="highlighter-rouge">CSV.encode(file)</code> is called, the auto-alias directs the app to instead look for an <code class="highlighter-rouge">encode/1</code> function on the <code class="highlighter-rouge">Elixir.Foo.CSV</code> module.</p> <p>Yet, when modules are not nested, the compiler does not create an auto-alias, so there is no confusion about which <code class="highlighter-rouge">CSV</code> module I’m trying to reference.</p> <p>So if you are hitting a similar error with nested modules, consider either changing the name or switching over to a namespaced module instead.</p> </article> <hr> <div class="question"> <a class="twitter-follow-button" href="https://twitter.com/notjoeellis" data-show-count="true" data-size="large"> Follow @notjoeellis </a> <script type="text/javascript">window.twttr=function(t,e,r){var n,i,w=t.getElementsByTagName(e)[0];if(!t.getElementById(r))return i=t.createElement(e),i.id=r,i.src="https://platform.twitter.com/widgets.js",w.parentNode.insertBefore(i,w),window.twttr||(n={_e:[],ready:function(t){n._e.push(t)}})}(document,"script","twitter-wjs");</script> </div> </div> </div> <footer class="site-footer"> <p class="small">joeellis.la &copy; 2017</p> </footer> </div> </div> </body> <script>!function(e,t,a,n,c,s,o){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,s=t.createElement(a),o=t.getElementsByTagName(a)[0],s.async=1,s.src=n,o.parentNode.insertBefore(s,o)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-99074897-1","auto"),ga("send","pageview");</script> </html>